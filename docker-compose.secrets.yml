# Docker Compose Secrets Override
#
# This file extends docker-compose.yml to add Docker secrets support.
# Use this for local development with enhanced security.
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.secrets.yml up -d
#
# Prerequisites:
#   - Create secret files in infrastructure/secrets/ (see infrastructure/secrets/README.md)
#   - Or run: bash scripts/setup-secrets.sh

version: '3.8'

secrets:
  hf_token:
    file: ./infrastructure/secrets/hf_token.txt
  redis_password:
    file: ./infrastructure/secrets/redis_password.txt
  jwt_secret:
    file: ./infrastructure/secrets/jwt_secret.txt
  grafana_admin_password:
    file: ./infrastructure/secrets/grafana_admin_password.txt

services:
  # Redis with optional password
  redis:
    secrets:
      - redis_password
    # Note: Redis command will need to be updated to read password from /run/secrets/redis_password
    # For now, this prepares the infrastructure

  # Backend API
  backend:
    secrets:
      - redis_password
      - jwt_secret
    environment:
      # Services will read from /run/secrets/ first, then fall back to env vars
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - JWT_SECRET_KEY_FILE=/run/secrets/jwt_secret

  # STT Engine
  stt-engine:
    secrets:
      - redis_password
    environment:
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password

  # NLP Service
  nlp-service:
    secrets:
      - hf_token
      - redis_password
    environment:
      - HF_TOKEN_FILE=/run/secrets/hf_token
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password

  # Summary Service
  summary-service:
    secrets:
      - hf_token
      - redis_password
    environment:
      - HF_TOKEN_FILE=/run/secrets/hf_token
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password

  # Grafana with custom admin password
  grafana:
    secrets:
      - grafana_admin_password
    environment:
      # Override the hardcoded password with secret file
      - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_admin_password
